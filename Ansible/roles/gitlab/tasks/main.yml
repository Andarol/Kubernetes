---
  - name: Create the 'gitlab' namespace
    kubernetes.core.k8s:
      name: gitlab
      api_version: v1
      kind: Namespace
      state: present

  - name: Label the gitlab node
    shell: kubectl label nodes gitlab app=gitlab --overwrite
    register: label_result
    changed_when: "'labeled' in label_result.stdout"

  - name: Add the GitLab Helm repository
    kubernetes.core.helm_repository:
      name: gitlab
      repo_url: https://charts.gitlab.io/
      state: present

  - name: Update helm repositories
    command: helm repo update

  - name: Get gitlab node IP address
    shell: kubectl get nodes gitlab -o jsonpath='{.status.addresses[?(@.type=="InternalIP")].address}'
    register: gitlab_node_ip
    changed_when: false

  - name: Install GitLab using Helm with minimal configuration
    kubernetes.core.helm:
      name: gitlab
      chart_ref: gitlab/gitlab
      release_namespace: gitlab
      create_namespace: false
      wait: true
      wait_timeout: 20m
      atomic: true
      values:
        global:
          hosts:
            domain: "{{ gitlab_node_ip.stdout }}.nip.io"
            https: false
          edition: ce
          nodeSelector:
            app: gitlab
          email:
            from: "gitlab@{{ gitlab_node_ip.stdout }}.nip.io"
            reply_to: "noreply@{{ gitlab_node_ip.stdout }}.nip.io"
          service:
            type: NodePort
        certmanager:
          enabled: false
        certmanager-issuer:
          enabled: false
          email: admin@gitlab.local
        nginx-ingress:
          enabled: false
        prometheus:
          install: false
        gitlab-runner:
          install: false
        postgresql:
          persistence:
            storageClass: local-path
            size: 2Gi
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
        redis:
          master:
            persistence:
              storageClass: local-path
              size: 1Gi
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
        minio:
          persistence:
            storageClass: local-path
            size: 8Gi
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
        gitaly:
          persistence:
            storageClass: local-path
            size: 20Gi
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
        gitlab:
          webservice:
            replicas: 1
            service:
              type: NodePort
            resources:
              requests:
                cpu: 200m
                memory: 512Mi
          sidekiq:
            replicas: 1
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
          gitlab-shell:
            replicas: 1
            resources:
              requests:
                cpu: 50m
                memory: 128Mi
        registry:
          enabled: true
          replicas: 1
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
        gitlab-shell:
          service:
            type: NodePort

  - name: Wait for GitLab to be ready
    shell: kubectl get pods -n gitlab --no-headers | grep -v "Running\|Completed" | wc -l
    register: pending_pods
    until: pending_pods.stdout | int == 0
    retries: 60
    delay: 30

  - name: Get all GitLab services
    shell: kubectl get svc -n gitlab
    register: gitlab_services

  - name: Display GitLab services
    debug:
      msg: "{{ gitlab_services.stdout_lines }}"

  - name: Get GitLab root password
    shell: kubectl get secret gitlab-gitlab-initial-root-password -n gitlab -o jsonpath='{.data.password}' | base64 -d
    register: gitlab_root_password
    retries: 10
    delay: 10
    failed_when: false

  - name: Display GitLab access information
    debug:
      msg:
        - "GitLab namespace: gitlab"
        - "Username: root"
        - "Password: {{ gitlab_root_password.stdout if gitlab_root_password.rc == 0 else 'Check: kubectl get secret gitlab-gitlab-initial-root-password -n gitlab -o jsonpath={.data.password} | base64 -d' }}"
        - "GitLab is exposed via NodePort"
        - "Get access details: kubectl get svc gitlab-webservice-default -n gitlab"